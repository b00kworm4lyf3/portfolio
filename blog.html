<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Brielle - Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="portfolio.css">
    <link rel="stylesheet" href="blog-styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">Sage Brielle</a>
            <div class="nav-links">
                <a href="work.html">Work</a>
                <a href="blog.html">Blog</a>
                <a href="about.html">About</a>
                <a href="#contact">Contact</a>
            </div>
        </div>
    </nav>
    
    <main class="blog-page">
        <header class="blog-header">
            <h1>Blog & Journal</h1>
            <p>Documenting my creative journey, assignments, and experiments</p>
        </header>

        <div class="blog-controls">
            <!-- Filter buttons will be generated here -->
            <div class="blog-filters" id="filterButtons">
                <span class="filter-label">Filter:</span>
            </div>

            <!-- Sort toggle -->
            <div class="blog-sort">
                <span class="sort-label">Sort:</span>
                <button class="sort-btn newest" id="sortToggle">
                    <span class="sort-text">Newest First</span>
                    <span class="sort-icon">↓</span>
                </button>
            </div>
        </div>

        <!-- Blog feed -->
        <div class="blog-feed" id="blogFeed">
            <div class="loading">Loading posts...</div>
        </div>

        <section class="contact" id="contact">
            <h2>Get In Touch</h2>
            <p>Interested in collaboration or have a project in mind? Let's talk!</p>
            <a href="mailto:sage.ebert@colorado.edu" class="cta-button">Contact Me</a>
        </section>
    </main>

    <script src="blog.js"></script>
    <script>
        let activeFilters = new Set();
        let tagCategories = {};

        function getTagsFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const tags = params.get('tags');
            const singleTag = params.get('tag');
            if (tags) return tags.split(',');
            if (singleTag) return [singleTag];
            return [];
        }

        async function initBlog() {
            await blogManager.loadPosts();
            
            // Get categories directly from posts
            tagCategories = blogManager.getTagsByCategory();
            
            generateFilterButtons();
            
            // Check for tags in URL
            const tagsFromUrl = getTagsFromUrl();
            if (tagsFromUrl.length > 0) {
                activeFilters = new Set(tagsFromUrl);
                updateFilterButtons();
            }
            
            displayPosts();
        }

        function generateFilterButtons() {
            const filterContainer = document.getElementById('filterButtons');
            
            let categoriesHtml = '<span class="filter-label">Filter:</span>';
            
            // Create a dropdown for each category
            for (let category in tagCategories) {
                const tags = tagCategories[category];
                if (tags.length === 0) continue;
                
                categoriesHtml += `
                    <div class="filter-category">
                        <button class="category-button" data-category="${category}">
                            ${category} <span class="category-arrow">▼</span>
                        </button>
                        <div class="category-dropdown" data-category="${category}">
                            ${tags.map(tag => 
                                `<button class="filter-tag" data-filter="${tag}">${tag}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            categoriesHtml += '<button class="filter-btn clear-filters" id="clearFilters" style="display: none;">Clear All</button>';
            
            filterContainer.innerHTML = categoriesHtml;

            // Add click handlers for category dropdowns
            filterContainer.querySelectorAll('.category-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = e.currentTarget.dataset.category;
                    const dropdown = filterContainer.querySelector(`.category-dropdown[data-category="${category}"]`);
                    const arrow = e.currentTarget.querySelector('.category-arrow');
                    
                    // Toggle this dropdown
                    const isOpen = dropdown.classList.contains('open');
                    
                    // Close all dropdowns
                    filterContainer.querySelectorAll('.category-dropdown').forEach(d => d.classList.remove('open'));
                    filterContainer.querySelectorAll('.category-arrow').forEach(a => a.textContent = '▼');
                    
                    // Open this one if it was closed
                    if (!isOpen) {
                        dropdown.classList.add('open');
                        arrow.textContent = '▲';
                    }
                });
            });

            // Add click handlers for tag buttons
            filterContainer.querySelectorAll('.filter-tag').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const filter = e.target.dataset.filter;
                    
                    if (activeFilters.has(filter)) {
                        activeFilters.delete(filter);
                    } else {
                        activeFilters.add(filter);
                    }
                    
                    displayPosts();
                    updateFilterButtons();
                    updateUrl();
                });
            });

            // Clear filters button
            document.getElementById('clearFilters').addEventListener('click', () => {
                activeFilters.clear();
                displayPosts();
                updateFilterButtons();
                updateUrl();
                // Close all dropdowns
                filterContainer.querySelectorAll('.category-dropdown').forEach(d => d.classList.remove('open'));
                filterContainer.querySelectorAll('.category-arrow').forEach(a => a.textContent = '▼');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.filter-category')) {
                    filterContainer.querySelectorAll('.category-dropdown').forEach(d => d.classList.remove('open'));
                    filterContainer.querySelectorAll('.category-arrow').forEach(a => a.textContent = '▼');
                }
            });
        }

        function updateFilterButtons() {
            const filterContainer = document.getElementById('filterButtons');
            const clearBtn = document.getElementById('clearFilters');
            
            // Update active states
            filterContainer.querySelectorAll('.filter-tag').forEach(btn => {
                if (activeFilters.has(btn.dataset.filter)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update category button to show count of active filters in that category
            for (let category in tagCategories) {
                const categoryBtn = filterContainer.querySelector(`.category-button[data-category="${category}"]`);
                const tagsInCategory = tagCategories[category];
                const activeInCategory = tagsInCategory.filter(tag => activeFilters.has(tag)).length;
                
                if (activeInCategory > 0) {
                    categoryBtn.classList.add('has-active');
                    // Update text to show count
                    const arrow = categoryBtn.querySelector('.category-arrow');
                    categoryBtn.childNodes[0].textContent = `${category} (${activeInCategory}) `;
                } else {
                    categoryBtn.classList.remove('has-active');
                    const arrow = categoryBtn.querySelector('.category-arrow');
                    categoryBtn.childNodes[0].textContent = `${category} `;
                }
            }
            
            // Show/hide clear button
            clearBtn.style.display = activeFilters.size > 0 ? 'inline-block' : 'none';
        }

        function updateUrl() {
            if (activeFilters.size === 0) {
                window.history.pushState({}, '', 'blog.html');
            } else {
                const tagsParam = Array.from(activeFilters).join(',');
                window.history.pushState({}, '', `blog.html?tags=${encodeURIComponent(tagsParam)}`);
            }
        }

        function displayPosts() {
            let posts;
            if (activeFilters.size === 0) {
                posts = blogManager.getAllPosts();
            } else {
                posts = blogManager.getAllPosts().filter(post => {
                    // Get all tags from post (flatten if categorized)
                    const postTags = Array.isArray(post.tags) 
                        ? post.tags 
                        : Object.values(post.tags).flat();
                    
                    // Check if post has ALL active tags
                    return Array.from(activeFilters).every(tag => 
                        postTags.some(t => t.toLowerCase() === tag.toLowerCase())
                    );
                });
            }
            
            const container = document.getElementById('blogFeed');
            
            if (posts.length === 0) {
                container.innerHTML = '<div class="no-posts">No posts match the selected filters.</div>';
                return;
            }

            container.innerHTML = posts.map(post => blogManager.renderPost(post)).join('');
            
            // Load any gists that were queued during render
            if (typeof loadPendingGists === 'function') {
                loadPendingGists();
            }
            
            // Add click handlers to tag links
            container.querySelectorAll('.tag-link').forEach(tag => {
                tag.addEventListener('click', () => {
                    const tagName = tag.dataset.tag;
                    activeFilters.clear();
                    activeFilters.add(tagName);
                    displayPosts();
                    updateFilterButtons();
                    updateUrl();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        }

        // Sort toggle functionality
        document.getElementById('sortToggle').addEventListener('click', function() {
            blogManager.toggleSortOrder();
            
            // Update button appearance
            if (blogManager.sortOrder === 'oldest') {
                this.classList.remove('newest');
                this.classList.add('oldest');
                this.querySelector('.sort-text').textContent = 'Oldest First';
            } else {
                this.classList.remove('oldest');
                this.classList.add('newest');
                this.querySelector('.sort-text').textContent = 'Newest First';
            }
            
            displayPosts();
        });

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBlog);
        } else {
            initBlog();
        }
    </script>
</body>
</html>